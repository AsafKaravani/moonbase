version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
global_job_config:
  prologue:
    commands:
      - checkout
blocks:
  - name: Static Code Analysis
    dependencies: []
    task:
      jobs:
        - name: Send code to SonarQube
          commands:
            - echo "Need to setup SonarQube"
        - name: Send code to Synk
          commands:
            - echo $blabla
  - name: Branch = Master
    dependencies:
      - Build
    run:
      when: branch = 'master'
    task:
      jobs:
        - name: Will pass only on master
          commands:
            - echo "Master branch detected"
  - name: Branch = Development
    dependencies:
      - Build
    run:
      when: branch = 'development'
    task:
      jobs:
        - name: Will pass only on development
          commands:
            - echo "Develop branch detected"
  - name: Deploy to Prod
    dependencies:
      - Branch = Master
    task:
      jobs:
        - name: Redeploy DigitalOcean droplet
          commands: []
  - name: Build
    dependencies:
      - Install
      - Lint
      - Static Code Analysis
    run:
      when: change_in('/services/client')
    task:
      jobs:
        - name: Docker build and push
          commands:
            - sh .semaphore/get-npm-package-version.sh ./services/client/package.json
            - echo $PACKAGE_VERSION
            - echo $MOONPACKET_DOCKER_PASSWORD | docker login --username "$MOONPACKET_DOCKER_USERNAME" --password-stdin
            - 'docker build ./services/client -t moonpacket/moobase-client:0.3.0'
      secrets:
        - name: MOONPACKET_DOCKER_PASSWORD
        - name: MOONPACKET_DOCKER_USERNAME
  - name: Lint
    dependencies: []
    task:
      jobs:
        - name: Yarn lint
          commands:
            - yarn lint
  - name: Install
    dependencies: []
    task:
      jobs:
        - name: Yarn install
          commands:
            - yarn install
  - name: Deploy to Staging
    dependencies:
      - Branch = Development
    task:
      jobs:
        - name: Redeploy DigitalOcean droplet
          commands: []
    run:
      when: branch = 'development'
