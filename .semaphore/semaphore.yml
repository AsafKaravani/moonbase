version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
global_job_config:
  prologue:
    commands:
      - checkout
blocks:
  - name: Static Code Analysis
    dependencies: []
    task:
      jobs:
        - name: Send code to SonarQube
          commands:
            - echo "Need to setup SonarQube"
        - name: Send code to Synk
          commands:
            - echo $blabla
  - name: Branch = Master
    dependencies:
      - Build
    run:
      when: branch = 'master'
    task:
      jobs:
        - name: Will pass only on master
          commands:
            - echo "Master branch detected"
  - name: Branch = Development
    dependencies:
      - Build
    run:
      when: branch = 'development'
    task:
      jobs:
        - name: Will pass only on development
          commands:
            - echo "Develop branch detected"
  - name: Upload Builds
    dependencies:
      - Branch = Master
    task:
      jobs:
        - name: Docker push
          commands:
            - 'docker push moonpacket/moobase-client:0.3.0'
  - name: Build
    dependencies: []
    run:
      when: change_in('/services/client')
    task:
      jobs:
        - name: Docker login and build
          commands:
            - 'echo "${MOONPACKET_DOCKER_USERNAME}"'
            - echo $MOONPACKET_DOCKER_USERNAME
            - echo $MOONPACKET_DOCKER_PASSWORD
            - echo $MOONPACKET_DOCKER_PASSWORD| docker login --username "$MOONPACKET_DOCKER_USERNAME" --password-stdin
            - 'docker build ./services/client -t moonpacket/moobase-client:0.3.0'
        - name: Docker build client
          commands: []
  - name: Lint
    dependencies: []
    task:
      jobs:
        - name: Yarn lint
          commands:
            - yarn lint
  - name: Install
    dependencies: []
    task:
      jobs:
        - name: Yarn install
          commands:
            - yarn install
