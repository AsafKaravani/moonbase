version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Initialization
    task:
      jobs:
        - name: Checkout
          commands:
            - checkout
        - name: 'Job #4'
          commands:
            - export blabla=asdasdasd
    dependencies: []
  - name: Static Code Analysis
    dependencies:
      - Install
    task:
      jobs:
        - name: Send code to SonarQube
          commands:
            - echo "Need to setup SonarQube"
        - name: Send code to Synk
          commands:
            - echo $blabla
  - name: Branch = Master
    dependencies:
      - Build
    run:
      when: branch = 'master'
    task:
      jobs:
        - name: Will pass only on master
          commands:
            - echo "Master branch detected"
  - name: Branch = Development
    dependencies:
      - Build
    run:
      when: branch = 'development'
    task:
      jobs:
        - name: Will pass only on development
          commands:
            - echo "Develop branch detected"
  - name: Upload Builds
    dependencies:
      - Branch = Master
    task:
      jobs:
        - name: Docker push
          commands:
            - 'docker push moonpacket/moobase-client:0.3.0'
  - name: Build
    dependencies:
      - Static Code Analysis
    run:
      when: change_in('/services/client')
    task:
      jobs:
        - name: Docker login
          commands:
            - 'echo "${MOONPACKET_DOCKER_PASSWORD}" | docker login -u "${MOONPACKET_DOCKER_USERNAME}" --password-stdin'
        - name: Docker build client
          commands:
            - 'echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin'
            - 'docker build ./services/client -t moonpacket/moobase-client:0.3.0'
  - name: Lint
    dependencies:
      - Initialization
    task:
      jobs:
        - name: Yarn lint
          commands:
            - yarn lint
  - name: Install
    dependencies:
      - Lint
    task:
      jobs:
        - name: Yarn lint
          commands:
            - yarn install
